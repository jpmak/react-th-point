<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <title>兑换商城</title>
    <meta content="兑换商城" name="keywords">
    <meta content="兑换商城" name="description">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimum-scale=1.0, maximum-scale=1.0">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no" />
    <link rel="stylesheet" type="text/css" href="{WapCss}main.css">
    <link rel="stylesheet" type="text/css" href="{WapCss}point/base.css">
    <link rel="stylesheet" type="text/css" href="{WapCss}point/jf.css">
    <link rel="stylesheet" type="text/css" href="{WapCss}point/swiper.min.css">
    <script src="{WapJs}jquery-1.10.1.min.js"></script>
    <script>
    </script>
</head>

<body>
    <header>
        <div class="th-nav wbox ">
            <div class="th-nav-back">
                <a href="javascript:location='Index-index.html';">返回</a>
            </div>
            <div class="th-nav-title of bg">兑换商城</div>
            <div class="th-nav-right tr">
                <a class="jf-record-icon" href="Exchange-orderList.html">
                </a>
            </div>
        </div>
    </header>
    <!--分类搜索-->
    <div class="w">
        <div class="th-search-container on-blur" style="display: block;">
            <div class="th-search-box">
                <div class="th-search-shadow"></div>
                <a class="class sorts" href="Exchange-category.html"></a>
                <a class="backbtn"></a>
                <a class="search-btn" style="width:.7rem; display:inline-block;">搜索</a>
                <div class="wbox search-bar pr">
                    <i class="th-search-iconbtn"></i>
                    <div id="del" class="delete" onclick="del()"></div>
                    <div class="wbox-flex">
                        <form class="th-search-form">
                            <input id="searchInput" class="th-search-form" type="text" placeholder="搜索商品关键字" autocomplete="off">
                        </form>
                    </div>
                </div>
            </div>
            <div class="search-wrap">
                <?php if( !empty($search_history) ){  ?>
                <div class="search-keywords bor-b">
                    <div class="search-keywords-name">
                        <span>历史记录 <i class="delbtn" style="display: none;"></i></span>
                    </div>
                    <div class="search-keywords-list ">
                        <?php $num=0; foreach($search_history as $k => $v){ ?>
                        <?php 
                        $num++;
                        if($num<9){
                    ?>
                        <li>
                            <a>
                                <?=$v?>
                            </a>
                        </li>
                        <?php }} ?>
                    </div>
                </div>
                <div class="search-keywords">
                    <div class="search-keywords-name" style="display: none;">
                        <span>热门记录</span>
                    </div>
                    <div class="search-keywords-list ">
                    </div>
                </div>
                <?php } ?>
            </div>
        </div>
        <!-- 搜索区域 -->
        <div class="scroll-wrapper">
            <div class="jf-floor-banner">
                <div class="swiper-container swiper1">
                    <div class="swiper-wrapper">
                    </div>
                    <div class="swiper-pagination swiper-pagination1"></div>
                </div>
            </div>
            <!-- 积分兑换记录 -->
            <div class="jf-record">
                <div class="box">
                    <div class="jf-left">
                        <i class="th-banana-iconbtn"></i>
                        <div id="record-num" class="num"></div>
                    </div>
                    <div class="jf-right"><a class="record" href="Exchange-exchangeLog.html">兑换记录</a></div>
                </div>
            </div>
            <!-- 兑换排行榜 -->
            <style>

            </style>
            <div class="fl-space"></div>
            <div class="jf-bsell-box">
                <div id="js-banner" class="banner">
                </div>
                <div id="sales-wrapper">
                    <div id="scroller" class="list">
                        <ul>
                        </ul>
                    </div>
                </div>
                <div id="js-banner-2" class="banner-bottom">
                </div>
            </div>
            <div class="fl-space"></div>
            <!--      积分分类 -->
            <div class="app-pro-holder mt20">
                <!-- scroller -->
                <div>
                    <div id="app-scroller" class="app-scroller-wrap" style="height:.75rem;">
                        <div class="app-scroller">
                            <ul class="choose-items-wp">
                                <p style="top:.7rem;"><b></b></p>
                            </ul>
                        </div>
                    </div>
                </div>
                <!-- scroller -->
                <div class="app-pd-wp">
                    <div class="app-pd-list">
                        <ul>
                        </ul>
                    </div>
                </div>
                <div class="load-tip"></div>
            </div>
        </div>
        <!-- scroll-wrapper-end-->
    </div>
</body>

</html>
<script src="{WapJs}zzjCookie.js"></script>
<script src="{WapJs}tool.js"></script>
<script src="{WapJs}ptsWebView1.2.js"></script>
<script src="{WapJs}Base64.js"></script>
<script src="{WapJs}jweixin-1.0.0.js"></script>
<script src="{WapJs}wxClass.js"></script>
<script src="{WapJs}httpUrlAction.js"></script>
<script src="{WapJs}ptsAjax.js"></script>
<script src="{WapJs}jq.lazyload.js"></script>
<script src="{WapJs}swiper.jquery.min.js"></script>
<script>
Load.show();
var page = 0;
var page_state = 1;
var cate_list_type = 0;
var skey = '';
//商品一级分类
function get_cate_list() {
    cate_list_Html = '';
    ptsAjax({
        'url': urlRoot + '?g=WapSite&c=Exchange&a=get_cate_list',
        'type': 'json',
        'Thread': true,
        'complete': function() {
            Load.hide();
        },
        'error': function() {
            alert('网络连接失败！');
        },
        success: function(data, textStatus, xhr) {
            if (data.status) {
                var sales_top = '';
                for (var i = 0; i < data.cate_list.length; i++) {
                    // console.log(data.cate_list[i].cate_id);
                    cate_list_Html += '<li style="border:1px solid #e1e1e1;" onclick="cate_list_state(' + data.cate_list[i].cate_id + ')"><a><span>' + data.cate_list[i].cate_name + '</span></a></li>'
                }
                cate_list_state(data.cate_list[0].cate_id);
                $('.choose-items-wp').append(cate_list_Html);
                $('.choose-items-wp li').first().addClass('act');
                // 初始化
                $(function() {
                    var nav_w = $(".app-scroller li").first().width();
                    var fl_w = $(".app-scroller").width();
                    var flb_w = $(".app-scroller-wrap").width();

                    $(".app-scroller li").on("click", function() {
                        // var liindex = $('.app-scroller li').index(this);
                        //   cate_list_state(liindex);
                        Load.show();
                        nav_w = $(this).width();
                        $(".choose-items-wp p").stop(true);
                        $(".choose-items-wp p").animate({
                            left: $(this).position().left
                        }, 300);
                        $(".choose-items-wp p").animate({
                            width: nav_w
                        });
                        // var fn_w = ($(".app-scroller-wrap").width() - nav_w) / 2;

                        // var fnl_l;
                        // var fnl_x = parseInt($(this).position().left);
                        // $(this).addClass('act').siblings().removeClass('act');
                        // if (fnl_x <= fn_w) {
                        //     fnl_l = 0;
                        // } else if (fn_w - fnl_x <= flb_w - fl_w) {
                        //     fnl_l = flb_w - fl_w;
                        // } else {
                        //     fnl_l = fn_w - fnl_x;
                        // }
                        // $(".app-scroller").animate({
                        //     "left": fnl_l
                        // }, 300);
                        // sessionStorage.left = fnl_l;
                        // var c_nav = $(this).find("a").text();
                        // navName(c_nav);
                    });

                    $(".app-scroller").on('touchstart', function(e) {
                        var touch1 = e.originalEvent.targetTouches[0];
                        x1 = touch1.pageX;
                        y1 = touch1.pageY;
                        ty_left = parseInt($(this).css("left"));
                    });
                    $(".app-scroller").on('touchmove', function(e) {
                        var touch2 = e.originalEvent.targetTouches[0];
                        var x2 = touch2.pageX;
                        var y2 = touch2.pageY;
                        if (ty_left + x2 - x1 >= 0) {
                            $(this).css("left", 0);
                        } else if (ty_left + x2 - x1 <= flb_w - fl_w) {
                            $(this).css("left", flb_w - fl_w);
                        } else {
                            $(this).css("left", ty_left + x2 - x1);
                        }
                        if (Math.abs(y2 - y1) > 0) {
                            e.preventDefault();
                        }
                    });
                });
                // 初始化

            }
        }
    });
}

function cate_list_state(obj) {
    cate_list_type = obj;
    page_state = 1;
    page = 0;

    get_cate_goods();
}
//商品分类对应商品
function get_cate_goods() {

    ptsAjax({
        'url': urlRoot + '?g=WapSite&c=Exchange&a=get_cate_goods',
        'type': 'json',
        'Thread': true,
        'data': {
            'cate_id': cate_list_type,
            'page': page
        },
        'complete': function() {
            Load.hide();
        },
        'error': function() {
            alert('网络连接失败！');
        },
        success: function(data, textStatus, xhr) {
            var cate_listHtml = '';
            if (data.status) {
                Load.hide();
                var sales_top = '';
                for (var i = 0; i < data.goods_list.length; i++) {
                    cate_listHtml += '  <li><a href="Exchange-goods-' + data.goods_list[i].item_id + '.html"><div class="info-img"><img alt="" class="lazy" data-original="' + data.goods_list[i].list_image + '"></div><div class="info-bar"><div class="pro-title">' + data.goods_list[i].goods_name + '</div><div class="e-numb"><span class="e-price"><em>' + data.goods_list[i].item_price + '</em>积分</span></div></div></a></li>'
                }
                // 
                if (page == 0) {
                    $('.app-pd-list ul').html(cate_listHtml);

                } else {
                    $('.app-pd-list ul').append(cate_listHtml);
                    page_state = 1;
                    $('.load-tip').hide();
                }

                Load.hide();
            } else {
                if (page == 0) {
                    var liHtml = '';
                    liHtml += '<div class="none-data"></div>';
                    $('.app-pd-list ul').html(liHtml);
                    $('.load-tip').hide();
                    page_state = 0;
                } else {
                    $('.load-tip').show().html("没有更多数据了");

                }
            }
            // else {
            //     var liHtml = '';
            //     liHtml += '<div class="none-data"></div>';
            //     if (page == 0) {
            //         page_state == 0;
            //         $('.app-pd-list ul').html(liHtml);
            //         console.log(page);
            //         $('.load-tip').hide();
            //     } else {
            //               console.log(123);
            //         $('.load-tip').show().html("没有更多数据了");
            //     }
            // }
            $(".app-pd-list img.lazy").show().lazyload({
                placeholder: "/../public/wapsite/images/point/f-bg.gif",
                skip_invisible: false,
                effect: "fadeIn",
                threshold: 0,
            });
        }
    });
}

var winH = $(window).height();
$(window).scroll(function() {
    var pageH = $(document.body).height();
    var scrollT = $(window).scrollTop();
    var rate = (pageH - winH - scrollT) / winH;
    if (page_state == 1) {
        if (rate < 0.01) {
            page++;
            page_state = 0;
            get_cate_goods();
            $('.load-tip').show().html('<i class="r-gif"></i><span>正在载入</span>');

        }
    }
});

//排行榜
function sales_volume() {
    scrollerHtml = '';

    ptsAjax({
        'url': urlRoot + '?g=WapSite&c=Exchange&a=sales_volume',
        'type': 'json',
        'Thread': true,
        'complete': function() {
            Load.hide();
        },
        'error': function() {
            alert('网络连接失败！');
        },
        success: function(data, textStatus, xhr) {
            if (data.status) {
                var sales_top = '';
                for (var i = 0; i < data.goods_list.length; i++) {
                    switch (i) {
                        case 0:
                            sales_top = 't1';
                            break;
                        case 1:
                            sales_top = 't2';
                            break;
                        case 2:
                            sales_top = 't3';
                            break;
                        case 3:
                            sales_top = '';
                            break;
                    }
                    scrollerHtml += '<li><a href="Exchange-goods-' + data.goods_list[i].item_id + '.html"><div class="info-img"><div class="top ' + sales_top + '"></div><img alt="" class="lazy"   data-original="' + data.goods_list[i].list_image + '"></div><div class="info-bar"><div class="pro-title">' + data.goods_list[i].goods_name + '</div><div class="e-numb"><span class="e-price"><em>' + data.goods_list[i].item_price + '</em>积分</span></div></div></a> </li>'
                }
                $('#sales-wrapper #scroller ul').html(scrollerHtml);
                $("img.lazy").show().lazyload({
                    container: $("#sales-wrapper"),
                    effect: "fadeIn",

                });
            }else{
                $('#sales-wrapper').remove();
            }
        }
    });
}
//获取积分参数
function user_info() {
    ptsAjax({
        'url': urlRoot + '?g=WapSite&c=Exchange&a=user_info',
        'type': 'json',
        'Thread': true,
        'complete': function() {
            Load.hide();
        },
        'error': function() {
            alert('网络连接失败！');
        },
        success: function(data, textStatus, xhr) {
            if (data.status) {
                $('#record-num').html(data.info.banana);
            } else {
                $('#record-num').html(0);
            }

        }
    });
}

function get_index_Banner() {
    bannerHtml = '';
    bann_foo1_html = '';
    bann_foo2_html = '';
    ptsAjax({
        'url': urlRoot + '?g=WapSite&c=Exchange&a=get_index_Banner',
        'type': 'json',
        'Thread': true,
        'complete': function() {
            Load.hide();
        },
        'error': function() {
            alert('网络连接失败！');
        },
        success: function(data, textStatus, xhr) {
            if (data.status) {
                var href = '';
                for (var i = 0; i < data.bann_top.advList.length; i++) {

                    if (data.bann_top.advList[i].adv_url != '') {
                        href = 'href="' + data.bann_top.advList[i].adv_url + '"';
                    } else {
                        href = '';
                    }
                    bannerHtml += '<div class="swiper-slide"><a ' + href + '><img class="swiper-lazy"  data-src="' + data.bann_top.advList[i].adv_img + '"  ></a></div>'
                }
                $('.swiper-wrapper').html(bannerHtml);

                var bann_foo1_href = '';
                if(data.bann_foo1.advList.length>0){
                    if (data.bann_foo1.advList[0].adv_url != '') {
                        bann_foo1_href = 'href="' + data.bann_foo2.advList[0].adv_url + '"';
                    } else {
                        bann_foo2_href = '';
                    }
                    bann_foo1_html += '<a ' + bann_foo1_href + '><img class="img-banner" src="' + data.bann_foo1.advList[0].adv_img + '"></a>';

                    $('#js-banner').html(bann_foo1_html);
                }else{
                    $('#js-banner').remove();
                }
                var bann_foo2_href = '';
                if(data.bann_foo2.advList.length>0){
                    if (data.bann_foo2.advList[0].adv_url != '') {
                        bann_foo2_href = 'href="' + data.bann_foo2.advList[0].adv_url + '"';
                    } else {
                        bann_foo2_href = '';
                    }
                    bann_foo2_html += '<a ' + bann_foo2_href + '><img class="lazy" src="' + data.bann_foo2.advList[0].adv_img + '"></a>';
                    $('#js-banner-2').html(bann_foo2_html);
                }else{
                    $('#js-banner-2').remove();
                }
                var swiper1 = new Swiper('.swiper1', {
                    pagination: '.swiper-pagination1',
                    preloadImages: false,
                    lazyLoading: true, // 滚动加载
                    paginationClickable: true,
                    spaceBetween: 0,
                    centeredSlides: true,
                    autoplay: 2500,
                    autoplayDisableOnInteraction: false,
                    loop: true,
                    observer: true, //修改swiper自己或子元素时，自动初始化swiper
                    observeParents: true, //修改swiper的父元素时，自动初始化swiper
                });
            }
            $("img.lazy").show().lazyload({
                placeholder: "/../public/wapsite/images/point/f-bg.gif",
                skip_invisible: false,
                effect: "fadeIn",
                threshold: 50,
            });
        }
    });
}
// get_index_Banner()
function search_cache() {
    ptsAjax({
        'url': urlRoot + '?g=WapSite&c=Exchange&a=search_cache',
        'type': 'json',
        'Thread': true,
        'data': {
            'kd': skey,
        },
        'complete': function() {
            Load.hide();
        },
        'error': function() {
            alert('网络连接失败！');
        },
        success: function(data, textStatus, xhr) {
            if (data.status) {
                window.location.href = "Exchange-search.html";
            }


        }
    });
}
</script>
<script>
user_info();
sales_volume();
get_cate_list();
$(function() {
    get_index_Banner();
    $('a.search-btn').on('click', function() {
        var sVal = $("#searchInput").val();
        if (sVal !== '') {
            skey = sVal;
            search_cache();
        }
    });

    $('.search-keywords-list li a').on('click', function() {
        var hVal = $(this).html();
        skey = hVal;
        search_cache();
    });

});
</script>
<script>
</script>
<script src="{WapJs}point/jf.js"></script>
<script>
<?=$fx_weixin?>
</script>
